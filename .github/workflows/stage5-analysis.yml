name: "Stage 5: Analysis & Reports"

on:
  schedule:
    # 매일 한국시간 15:00 (UTC 06:00)
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  stage5:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2시간 타임아웃

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: data-collector/requirements.txt

      - name: Install dependencies
        run: |
          cd data-collector
          pip install -r requirements.txt
          playwright install chromium

      - name: Verify installed packages
        run: |
          echo "=== Anthropic SDK version ==="
          pip show anthropic | grep -E "Name|Version|Requires"
          echo "=== httpx version ==="
          pip show httpx | grep -E "Name|Version"

      - name: Test Claude API connectivity
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python -c "
          import anthropic
          import httpx
          import os, socket, hashlib

          print('=== Environment Check ===')
          key = os.environ.get('ANTHROPIC_API_KEY', '')
          print(f'API key length: {len(key)}')
          print(f'API key prefix: {key[:15]}...' if len(key) > 15 else 'KEY TOO SHORT OR MISSING')
          print(f'API key hash (last 8): {hashlib.sha256(key.encode()).hexdigest()[-8:]}')
          print(f'Starts with sk-ant-: {key.startswith(\"sk-ant-\")}')
          print(f'anthropic SDK: {anthropic.__version__}')
          print(f'httpx: {httpx.__version__}')

          print()
          print('=== DNS Resolution ===')
          try:
              ips = socket.getaddrinfo('api.anthropic.com', 443)
              print(f'DNS OK: {ips[0][4]}')
          except Exception as de:
              print(f'DNS FAILED: {de}')

          print()
          print('=== Direct HTTPS Test ===')
          try:
              r = httpx.get('https://api.anthropic.com', timeout=15)
              print(f'HTTPS OK: status={r.status_code}')
          except Exception as he:
              print(f'HTTPS FAILED: {type(he).__name__}: {he}')

          print()
          print('=== Claude API Test ===')
          try:
              client = anthropic.Anthropic(api_key=key, timeout=30.0)
              msg = client.messages.create(
                  model='claude-haiku-4-5-20251001',
                  max_tokens=10,
                  messages=[{'role': 'user', 'content': 'Say OK'}]
              )
              print(f'API SUCCESS: {msg.content[0].text}')
              print(f'Model: {msg.model}, Tokens: {msg.usage.input_tokens}+{msg.usage.output_tokens}')
          except anthropic.AuthenticationError as e:
              print(f'AUTH ERROR (API key invalid!): {e}')
          except anthropic.APIConnectionError as e:
              print(f'CONNECTION ERROR: {e}')
              print(f'Cause type: {type(e.__cause__).__name__ if e.__cause__ else \"None\"}')
              print(f'Cause detail: {e.__cause__}')
              if hasattr(e.__cause__, '__cause__') and e.__cause__.__cause__:
                  print(f'Root cause: {type(e.__cause__.__cause__).__name__}: {e.__cause__.__cause__}')
          except Exception as e:
              print(f'OTHER ERROR: {type(e).__name__}: {e}')
          "

      - name: Check for Stage 4 data
        run: |
          echo "=== Checking for Stage 4 intermediate files ==="
          ls -la data-collector/output/intermediate_*_stage4.json 2>/dev/null || echo "No stage4 files found in repo"
          ls -la data-collector/output/intermediate_*.json 2>/dev/null || echo "No intermediate files found"

      - name: Run Stage 5 (Analysis)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd data-collector
          python main.py --mode stage5

      - name: Copy all data to frontend
        run: |
          # Copy M1/M2 module data
          cp data-collector/output/m1_*.json app/src/data/ 2>/dev/null || true
          cp data-collector/output/m2_*.json app/src/data/ 2>/dev/null || true

          # Copy product attributes and ideation report
          cp data-collector/output/product_attributes_*.json app/src/data/product_attributes.json 2>/dev/null || true
          cp data-collector/output/product_ideation_report.json app/src/data/ 2>/dev/null || true

          # Copy final rankings
          cp data-collector/output/beauty_rankings_*.json app/src/data/historical/ 2>/dev/null || true
          cp data-collector/output/category_products.json app/src/data/ 2>/dev/null || true

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -f app/src/data/*.json app/src/data/historical/*.json 2>/dev/null || true
          echo "=== Git status ==="
          git status
          git diff --staged --quiet || git commit -m "Stage 5: Analysis complete $(date +'%Y-%m-%d %H:%M')"
          git stash --include-untracked || true
          git pull --rebase origin main || true
          git stash pop || true
          git push
